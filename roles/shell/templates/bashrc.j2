# ~/.bashrc - Terminal Setup Configuration
# Generated by terminal-setup Ansible playbook

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# History configuration
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoreboth:erasedups
shopt -s histappend

# Update window size after each command
shopt -s checkwinsize

# Enable programmable completion features
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi

# Better directory navigation
shopt -s autocd
shopt -s cdspell
shopt -s dirspell

# Enable ** globstar
shopt -s globstar

# Environment variables
export EDITOR=nvim
export VISUAL=nvim
export PAGER=less
export TERM=xterm-256color

# Path configuration
export PATH="$HOME/.local/bin:$PATH"
{% if ansible_os_family == "Darwin" %}
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"
{% endif %}

# UV (Python) configuration
export UV_SYSTEM_PYTHON=1

# FZF configuration
if command -v fd &> /dev/null; then
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
else
  export FZF_DEFAULT_COMMAND='find . -type f'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='find . -type d'
fi
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --inline-info --preview "bat --color=always --style=numbers {} 2>/dev/null || cat {}" --preview-window=right:60%:wrap'
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:500 {} 2>/dev/null || cat {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --level=2 --color=always {} 2>/dev/null || ls -la {} | head -200'"

# bat configuration
export BAT_THEME="TwoDark"

# Less configuration
export LESS='-R -F -X -i -M'
export LESSCHARSET='utf-8'

# Docker configuration
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# Load modular configurations
{% if use_starship_prompt | default(false) %}
# Starship prompt
eval "$(starship init bash)"
{% else %}
# Custom prompt
[ -f ~/.bash/prompt ] && source ~/.bash/prompt
{% endif %}
[ -f ~/.bash/aliases ] && source ~/.bash/aliases
[ -f ~/.bash/functions ] && source ~/.bash/functions

# Initialize zoxide (smart cd)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init bash)"
fi

# Initialize fzf
if command -v fzf &> /dev/null; then
{% if ansible_os_family == "Darwin" %}
  [ -f ~/.fzf.bash ] && source ~/.fzf.bash
  [ -f /opt/homebrew/opt/fzf/shell/completion.bash ] && source /opt/homebrew/opt/fzf/shell/completion.bash
  [ -f /opt/homebrew/opt/fzf/shell/key-bindings.bash ] && source /opt/homebrew/opt/fzf/shell/key-bindings.bash
{% else %}
  [ -f ~/.fzf.bash ] && source ~/.fzf.bash
  [ -f /usr/share/doc/fzf/examples/completion.bash ] && source /usr/share/doc/fzf/examples/completion.bash
  [ -f /usr/share/doc/fzf/examples/key-bindings.bash ] && source /usr/share/doc/fzf/examples/key-bindings.bash
{% endif %}
fi

# GitHub CLI completions
if command -v gh &> /dev/null; then
  eval "$(gh completion -s bash)"
fi

# UV (Python) completion
if command -v uv &> /dev/null; then
  eval "$(uv generate-shell-completion bash)"
fi

{% if ansible_os_family == "Darwin" %}
# macOS specific configurations
export BASH_SILENCE_DEPRECATION_WARNING=1

# Homebrew completion
if type brew &>/dev/null; then
  HOMEBREW_PREFIX="$(brew --prefix)"
  if [[ -r "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh" ]]; then
    source "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh"
  fi
fi
{% endif %}

# Local customizations (not managed by Ansible)
[ -f ~/.bashrc.local ] && source ~/.bashrc.local

# Welcome message
if [ -t 0 ]; then
  if command -v fastfetch &> /dev/null; then
    fastfetch
  fi
fi


# ~/.zshrc - Terminal Setup Configuration
# Generated by terminal-setup Ansible playbook

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=20000
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_SAVE_NO_DUPS
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY

# Better directory navigation
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT

# Enable globbing
setopt EXTENDED_GLOB
setopt NOMATCH

# Environment variables
export EDITOR=nvim
export VISUAL=nvim
export PAGER=less
export TERM=xterm-256color

# Path configuration
export PATH="$HOME/.local/bin:$PATH"
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"

# UV (Python) configuration
export UV_SYSTEM_PYTHON=1

# FZF configuration
if command -v fd &> /dev/null; then
  export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
else
  export FZF_DEFAULT_COMMAND='find . -type f'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='find . -type d'
fi
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --inline-info --preview "bat --color=always --style=numbers {} 2>/dev/null || cat {}" --preview-window=right:60%:wrap'
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:500 {} 2>/dev/null || cat {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --level=2 --color=always {} 2>/dev/null || ls -la {} | head -200'"

# bat configuration
export BAT_THEME="TwoDark"

# Less configuration
export LESS='-R -F -X -i -M'
export LESSCHARSET='utf-8'

# Docker configuration
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# Enable completion system
autoload -Uz compinit
compinit

# Load modular configurations
{% if use_starship_prompt | default(false) %}
# Starship prompt
eval "$(starship init zsh)"
{% else %}
# Custom prompt
[ -f ~/.zsh/prompt ] && source ~/.zsh/prompt
{% endif %}
[ -f ~/.zsh/aliases ] && source ~/.zsh/aliases
[ -f ~/.zsh/functions ] && source ~/.zsh/functions

# Initialize zoxide (smart cd)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
fi

# Initialize fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
if type brew &>/dev/null; then
  [ -f $(brew --prefix)/opt/fzf/shell/completion.zsh ] && source $(brew --prefix)/opt/fzf/shell/completion.zsh
  [ -f $(brew --prefix)/opt/fzf/shell/key-bindings.zsh ] && source $(brew --prefix)/opt/fzf/shell/key-bindings.zsh
fi

# GitHub CLI completions
if command -v gh &> /dev/null; then
  eval "$(gh completion -s zsh)"
fi

# UV (Python) completion
if command -v uv &> /dev/null; then
  eval "$(uv generate-shell-completion zsh)"
fi

# Homebrew completion
if type brew &>/dev/null; then
  FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi


# Completion styling
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' special-dirs true

# Key bindings (emacs-style)
bindkey -e
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward
bindkey '^[[1;5C' forward-word
bindkey '^[[1;5D' backward-word

# Local customizations (not managed by Ansible)
[ -f ~/.zshrc.local ] && source ~/.zshrc.local

# Welcome message
if [ -t 0 ]; then
  if command -v fastfetch &> /dev/null; then
    fastfetch
  fi
fi


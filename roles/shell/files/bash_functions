# Quick directory creation and navigation
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Extract any archive type
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"     ;;
      *.tar.gz)    tar xzf "$1"     ;;
      *.bz2)       bunzip2 "$1"     ;;
      *.rar)       unrar x "$1"     ;;
      *.gz)        gunzip "$1"      ;;
      *.tar)       tar xf "$1"      ;;
      *.tbz2)      tar xjf "$1"     ;;
      *.tgz)       tar xzf "$1"     ;;
      *.zip)       unzip "$1"       ;;
      *.Z)         uncompress "$1"  ;;
      *.7z)        7z x "$1"        ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Compress files/folders
compress() {
  tar -czf "${1%/}.tar.gz" "${1%/}"
}

# Find and kill process by name
killp() {
  if [ -z "$1" ]; then
    echo "Usage: killp <process_name>"
    return 1
  fi
  local pids
  pids=$(pgrep -f "$1" 2>/dev/null)
  if [ -z "$pids" ]; then
    echo "No process matching '$1' found"
    return 1
  fi
  echo "Found processes: $pids"
  echo "$pids" | xargs kill -15 2>/dev/null || echo "$pids" | xargs kill -9 2>/dev/null
  echo "Sent termination signal to matching processes"
}

# Create a backup of a file
backup() {
  cp "$1"{,.backup-$(date +%Y%m%d-%H%M%S)}
}

# Quick HTTP server (Python)
serve() {
  local port="${1:-8000}"
  echo "Starting HTTP server on port $port..."
  python3 -m http.server "$port"
}

# Git clone and cd into it
gcl() {
  git clone "$1" && cd "$(basename "$1" .git)"
}

# Create new branch and switch to it
gnb() {
  git checkout -b "$1"
}

# Git commit with conventional commits
gcom() {
  local type="$1"
  shift
  git commit -m "${type}: $*"
}

# Docker: Remove all stopped containers
docker-rm-stopped() {
  local containers
  containers=$(docker ps -aq 2>/dev/null)
  if [ -z "$containers" ]; then
    echo "No containers to remove"
    return 0
  fi
  docker rm $containers
}

# Docker: Remove all dangling images
docker-rm-images() {
  local images
  images=$(docker images -qf "dangling=true" 2>/dev/null)
  if [ -z "$images" ]; then
    echo "No dangling images to remove"
    return 0
  fi
  docker rmi $images
}

# Docker: Enter a running container
denter() {
  docker exec -it "$1" /bin/bash || docker exec -it "$1" /bin/sh
}

# Create Python virtual environment and activate
venv() {
  uv venv "$@"
  source .venv/bin/activate
}

# Find in current directory
findf() {
  find . -type f -name "*$1*"
}

# Find directory
findd() {
  find . -type d -name "*$1*"
}

# Search in files
search() {
  rg -i "$1" .
}

# Quick grep through history
hgrep() {
  history | grep "$1"
}

# Weather check
weather() {
  curl -s "wttr.in/${1:-}" | head -n 7
}

# Cheat sheet for commands
cheat() {
  curl -s "cheat.sh/$1"
}

# Generate random password
genpass() {
  local length="${1:-20}"
  # Generate enough random bytes to ensure we have enough characters after base64 encoding
  openssl rand -base64 48 | tr -dc 'a-zA-Z0-9' | head -c "$length"
  echo
}

# Docker cleanup everything
docker-cleanup() {
  echo "üßπ Cleaning up Docker..."
  docker system prune -af --volumes
  echo "‚úÖ Done!"
}

# Show disk usage of current directory sorted
duh() {
  du -h --max-depth=1 | sort -hr
}

# Count files in directory
count() {
  find "${1:-.}" -type f | wc -l
}

# Quick note taking
note() {
  local note_file="$HOME/.notes/$(date +%Y-%m-%d).md"
  mkdir -p "$HOME/.notes"
  echo "# $(date '+%Y-%m-%d %H:%M:%S')" >> "$note_file"
  echo "" >> "$note_file"
  if [ $# -eq 0 ]; then
    nvim + "$note_file"
  else
    echo "$*" >> "$note_file"
    echo "‚úÖ Note saved to $note_file"
  fi
}

# Git: Show changed files in last commit
gchanged() {
  git diff-tree --no-commit-id --name-only -r HEAD
}

# Git: Undo last commit but keep changes
gundo() {
  git reset --soft HEAD~1
}

# Show public IP and copy to clipboard
myip() {
  local ip=$(curl -s ifconfig.me)
  echo "$ip"
  
  # Copy to clipboard (macOS or Linux)
  if command -v pbcopy &> /dev/null; then
    echo -n "$ip" | pbcopy && echo "‚úÖ Copied to clipboard"
  elif command -v xclip &> /dev/null; then
    if echo -n "$ip" | xclip -selection clipboard 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  elif command -v xsel &> /dev/null; then
    if echo -n "$ip" | xsel --clipboard --input 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  elif command -v wl-copy &> /dev/null; then
    if echo -n "$ip" | wl-copy 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  fi
}

# Show local IP and copy to clipboard
localip() {
  local ip
  if [[ "$OSTYPE" == "darwin"* ]]; then
    ip=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || echo "No IP found")
  else
    ip=$(hostname -I | cut -d" " -f1)
  fi
  
  echo "$ip"
  
  # Copy to clipboard (macOS or Linux)
  if command -v pbcopy &> /dev/null; then
    echo -n "$ip" | pbcopy && echo "‚úÖ Copied to clipboard"
  elif command -v xclip &> /dev/null; then
    if echo -n "$ip" | xclip -selection clipboard 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  elif command -v xsel &> /dev/null; then
    if echo -n "$ip" | xsel --clipboard --input 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  elif command -v wl-copy &> /dev/null; then
    if echo -n "$ip" | wl-copy 2>/dev/null; then
      echo "‚úÖ Copied to clipboard"
    fi
  fi
}

# tmux: Create or attach to session
tm() {
  if [ -z "$1" ]; then
    tmux attach || tmux new
  else
    tmux attach -t "$1" || tmux new -s "$1"
  fi
}

# Update Zen terminal environment from repository
# Usage: zupdate [tags]
# Examples:
#   zupdate           # Update everything
#   zupdate shell     # Update only shell config
#   zupdate "shell,cli-tools"  # Update multiple components
zupdate() {
  local setup_dir=""
  local tags="${1:-}"

  # Colors
  local GREEN='\033[0;32m'
  local RED='\033[0;31m'
  local CYAN='\033[0;36m'
  local BOLD='\033[1m'
  local DIM='\033[2m'
  local NC='\033[0m'

  # Disable job control notifications (zsh)
  [[ -n "$ZSH_VERSION" ]] && setopt LOCAL_OPTIONS NO_NOTIFY NO_MONITOR

  # Run command with spinner (no job output)
  _run_silent() {
    local message=$1
    shift
    local frames="‚†ã ‚†ô ‚†π ‚†∏ ‚†º ‚†¥ ‚†¶ ‚†ß ‚†á ‚†è"
    local i=1
    local frame
    local pid
    local log=$_log_file

    # Run in subshell to avoid job notifications
    ( "$@" >> "$log" 2>&1 ) &
    pid=$!

    while kill -0 "$pid" 2>/dev/null; do
      frame=$(echo "$frames" | cut -d' ' -f$i)
      printf "\r\033[K${CYAN}%s${NC} %s" "$frame" "$message"
      i=$(( i % 10 + 1 ))
      sleep 0.1
    done
    printf "\r\033[K"

    wait $pid 2>/dev/null
    return $?
  }

  echo ""
  echo -e "${BOLD}Zen Update${NC}"
  echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

  # Try to find Zen directory
  if [ -n "$ZEN_SETUP_DIR" ] && [ -d "$ZEN_SETUP_DIR" ]; then
    setup_dir="$ZEN_SETUP_DIR"
  elif [ -d "$HOME/.local/share/zen-setup" ]; then
    setup_dir="$HOME/.local/share/zen-setup"
  else
    echo -e "${RED}‚úó${NC} Zen directory not found"
    echo ""
    echo -e "${DIM}Run: zsetdir /path/to/zen${NC}"
    return 1
  fi

  echo -e "${DIM}Directory: $setup_dir${NC}"
  echo ""

  # Save current directory (pushd is silent with -q in zsh, use redirect for bash)
  pushd "$setup_dir" > /dev/null 2>&1 || return 1

  # Create log file
  local _log_file="$setup_dir/logs/update-$(date +%Y%m%d_%H%M%S).log"
  mkdir -p "$setup_dir/logs"

  # Check for updates
  if ! _run_silent "Checking for updates..." git fetch origin; then
    echo -e "${RED}‚úó${NC} Failed to check for updates"
    popd > /dev/null 2>&1
    return 1
  fi

  # Check if there are changes
  local local_rev=$(git rev-parse HEAD 2>/dev/null)
  local remote_rev=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null)

  if [ "$local_rev" = "$remote_rev" ]; then
    echo -e "${GREEN}‚úì${NC} Already up to date"
    echo ""
    echo -e "${DIM}To force reinstall: zsetup${NC}"
    popd > /dev/null 2>&1
    return 0
  fi

  # Pull changes
  if ! _run_silent "Downloading updates..." git pull; then
    echo -e "${RED}‚úó${NC} Failed to pull changes"
    echo -e "${DIM}Check: $_log_file${NC}"
    popd > /dev/null 2>&1
    return 1
  fi
  echo -e "${GREEN}‚úì${NC} Updates downloaded"

  # Get sudo password on Linux
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    echo ""
    echo -n "Enter sudo password: "
    read -s BECOME_PASS
    echo ""
    export ANSIBLE_BECOME_PASS="$BECOME_PASS"
  fi

  # Suppress Ansible output
  export ANSIBLE_STDOUT_CALLBACK=minimal
  export ANSIBLE_DISPLAY_SKIPPED_HOSTS=false
  export ANSIBLE_DISPLAY_OK_HOSTS=false
  export ANSIBLE_NOCOLOR=1
  export ANSIBLE_NOCOWS=1

  # Run Ansible with spinner
  if [ -n "$tags" ]; then
    echo -e "${DIM}Components: $tags${NC}"
    _run_silent "Installing updates..." ansible-playbook playbook.yml --tags "$tags"
  else
    _run_silent "Installing updates..." ansible-playbook playbook.yml
  fi
  local exit_code=$?

  # Restore original directory
  popd > /dev/null 2>&1

  echo ""
  if [ $exit_code -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} Update complete"
    echo ""
    if [[ "$OSTYPE" == "darwin"* ]]; then
      echo -e "Run: ${BOLD}source ~/.zshrc${NC}"
    else
      echo -e "Run: ${BOLD}source ~/.bashrc${NC}"
    fi
  else
    echo -e "${RED}‚úó${NC} Update failed"
    echo -e "${DIM}Check: $_log_file${NC}"
    return $exit_code
  fi
}

  # Clean up backup files created by Zen
# Usage: zcleanup [--force]
# Examples:
#   zcleanup         # Interactive - shows backups and asks for confirmation
#   zcleanup --force # Delete all backups without confirmation
zcleanup() {
  local force=false
  if [ "$1" = "--force" ] || [ "$1" = "-f" ]; then
    force=true
  fi
  
  echo "üîç Finding backup files created by Zen..."
  echo ""
  
  # Find all backup files
  local backups=()
  
  # Set null_glob for zsh to prevent errors when no matches found
  if [ -n "$ZSH_VERSION" ]; then
    setopt local_options null_glob
  fi
  
  # Shell config backups
  for file in ~/.bashrc.backup.* ~/.zshrc.backup.* ~/.tmux.conf.backup.* ~/.config/nvim.backup.* ~/.local/share/nvim.backup.*; do
    if [ -e "$file" ]; then
      backups+=("$file")
    fi
  done
  
  # Check if any backups found
  if [ ${#backups[@]} -eq 0 ]; then
    echo "‚úÖ No backup files found!"
    return 0
  fi
  
  # Display found backups
  echo "üì¶ Found ${#backups[@]} backup(s):"
  echo ""
  for backup in "${backups[@]}"; do
    if [ -d "$backup" ]; then
      local size=$(du -sh "$backup" 2>/dev/null | cut -f1)
      echo "  üìÅ $backup ($size)"
    else
      local size=$(du -h "$backup" 2>/dev/null | cut -f1)
      echo "  üìÑ $backup ($size)"
    fi
  done
  
  echo ""
  
  # Ask for confirmation unless --force
  if [ "$force" = false ]; then
    if [ -n "$ZSH_VERSION" ]; then
      # Zsh syntax
      echo -n "üóëÔ∏è  Delete all these backups? (y/N) "
      read -r REPLY
    else
      # Bash syntax
      read -p "üóëÔ∏è  Delete all these backups? (y/N) " -n 1 -r REPLY
      echo
    fi
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "‚ùå Cancelled. No files deleted."
      return 0
    fi
  fi
  
  # Delete backups
  echo ""
  echo "üóëÔ∏è  Deleting backups..."
  for backup in "${backups[@]}"; do
    if [ -e "$backup" ]; then
      rm -rf "$backup"
      echo "  ‚úì Deleted: $backup"
    fi
  done
  
  echo ""
  echo "‚úÖ All backups cleaned up!"
}

# Set Zen directory location
# Usage: zsetdir [directory]
# Examples:
#   zsetdir ~/projects/zen
#   zsetdir  # Show current location
zsetdir() {
  local rc_file
  if [[ "$OSTYPE" == "darwin"* ]]; then
    rc_file="$HOME/.zshrc.local"
  else
    rc_file="$HOME/.bashrc.local"
  fi
  
  if [ -z "$1" ]; then
    # Show current location
    if [ -n "$ZEN_SETUP_DIR" ]; then
      echo "üìÇ Current Zen directory: $ZEN_SETUP_DIR"
    else
      echo "üìÇ No custom Zen directory set (using default: ~/.local/share/zen-setup)"
    fi
    echo ""
    echo "üí° To set a custom location:"
    echo "   zsetdir /path/to/your/zen"
    return 0
  fi
  
  local new_dir="$1"
  
  # Expand ~ to full path
  new_dir="${new_dir/#\~/$HOME}"
  
  # Check if directory exists
  if [ ! -d "$new_dir" ]; then
    echo "‚ùå Directory not found: $new_dir"
    return 1
  fi
  
  # Check if it's actually a Zen repository
  if [ ! -f "$new_dir/playbook.yml" ]; then
    echo "‚ö†Ô∏è  Warning: $new_dir doesn't look like a Zen repository"
    echo "   (playbook.yml not found)"
    if [ -n "$ZSH_VERSION" ]; then
      # Zsh syntax
      echo -n "Continue anyway? (y/N) "
      read -r REPLY
    else
      # Bash syntax
      read -p "Continue anyway? (y/N) " -n 1 -r REPLY
      echo
    fi
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      return 1
    fi
  fi
  
  # Add to local RC file
  echo "" >> "$rc_file"
  echo "# Zen directory (set by zsetdir)" >> "$rc_file"
  echo "export ZEN_SETUP_DIR=\"$new_dir\"" >> "$rc_file"
  
  # Set for current session
  export ZEN_SETUP_DIR="$new_dir"
  
  echo "‚úÖ Zen directory set to: $new_dir"
  echo "üìù Saved to: $rc_file"
  echo ""
  echo "üîÑ Reload your shell or run: source $rc_file"
}


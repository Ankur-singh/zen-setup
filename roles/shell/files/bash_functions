# Quick directory creation and navigation
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Extract any archive type
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"     ;;
      *.tar.gz)    tar xzf "$1"     ;;
      *.bz2)       bunzip2 "$1"     ;;
      *.rar)       unrar x "$1"     ;;
      *.gz)        gunzip "$1"      ;;
      *.tar)       tar xf "$1"      ;;
      *.tbz2)      tar xjf "$1"     ;;
      *.tgz)       tar xzf "$1"     ;;
      *.zip)       unzip "$1"       ;;
      *.Z)         uncompress "$1"  ;;
      *.7z)        7z x "$1"        ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Compress files/folders
compress() {
  tar -czf "${1%/}.tar.gz" "${1%/}"
}

# Find and kill process by name
killp() {
  ps aux | grep -v grep | grep "$1" | awk '{print $2}' | xargs kill -9
}

# Create a backup of a file
backup() {
  cp "$1"{,.backup-$(date +%Y%m%d-%H%M%S)}
}

# Quick HTTP server (Python)
serve() {
  local port="${1:-8000}"
  echo "Starting HTTP server on port $port..."
  python3 -m http.server "$port"
}

# Git clone and cd into it
gcl() {
  git clone "$1" && cd "$(basename "$1" .git)"
}

# Create new branch and switch to it
gnb() {
  git checkout -b "$1"
}

# Git commit with conventional commits
gcom() {
  local type="$1"
  shift
  git commit -m "${type}: $*"
}

# Docker: Remove all stopped containers
docker-rm-stopped() {
  docker rm $(docker ps -a -q)
}

# Docker: Remove all dangling images
docker-rm-images() {
  docker rmi $(docker images -f "dangling=true" -q)
}

# Docker: Enter a running container
denter() {
  docker exec -it "$1" /bin/bash || docker exec -it "$1" /bin/sh
}

# Create Python virtual environment and activate
venv() {
  uv venv "$@"
  source .venv/bin/activate
}

# Find in current directory
findf() {
  find . -type f -name "*$1*"
}

# Find directory
findd() {
  find . -type d -name "*$1*"
}

# Search in files
search() {
  rg -i "$1" .
}

# Quick grep through history
hgrep() {
  history | grep "$1"
}

# Weather check
weather() {
  curl -s "wttr.in/${1:-}" | head -n 7
}

# Cheat sheet for commands
cheat() {
  curl -s "cheat.sh/$1"
}

# Generate random password
genpass() {
  local length="${1:-20}"
  openssl rand -base64 32 | cut -c1-"$length"
}

# Docker cleanup everything
docker-cleanup() {
  echo "ğŸ§¹ Cleaning up Docker..."
  docker system prune -af --volumes
  echo "âœ… Done!"
}

# Show disk usage of current directory sorted
duh() {
  du -h --max-depth=1 | sort -hr
}

# Count files in directory
count() {
  find "${1:-.}" -type f | wc -l
}

# Quick note taking
note() {
  local note_file="$HOME/.notes/$(date +%Y-%m-%d).md"
  mkdir -p "$HOME/.notes"
  echo "# $(date '+%Y-%m-%d %H:%M:%S')" >> "$note_file"
  echo "" >> "$note_file"
  if [ $# -eq 0 ]; then
    nvim + "$note_file"
  else
    echo "$*" >> "$note_file"
    echo "âœ… Note saved to $note_file"
  fi
}

# Git: Show changed files in last commit
gchanged() {
  git diff-tree --no-commit-id --name-only -r HEAD
}

# Git: Undo last commit but keep changes
gundo() {
  git reset --soft HEAD~1
}

# Show public IP and copy to clipboard
myip() {
  local ip=$(curl -s ifconfig.me)
  echo "$ip"
  
  # Copy to clipboard (macOS or Linux)
  if command -v pbcopy &> /dev/null; then
    echo -n "$ip" | pbcopy && echo "âœ… Copied to clipboard"
  elif command -v xclip &> /dev/null; then
    if echo -n "$ip" | xclip -selection clipboard 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  elif command -v xsel &> /dev/null; then
    if echo -n "$ip" | xsel --clipboard --input 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  elif command -v wl-copy &> /dev/null; then
    if echo -n "$ip" | wl-copy 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  fi
}

# Show local IP and copy to clipboard
localip() {
  local ip
  if [[ "$OSTYPE" == "darwin"* ]]; then
    ip=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || echo "No IP found")
  else
    ip=$(hostname -I | cut -d" " -f1)
  fi
  
  echo "$ip"
  
  # Copy to clipboard (macOS or Linux)
  if command -v pbcopy &> /dev/null; then
    echo -n "$ip" | pbcopy && echo "âœ… Copied to clipboard"
  elif command -v xclip &> /dev/null; then
    if echo -n "$ip" | xclip -selection clipboard 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  elif command -v xsel &> /dev/null; then
    if echo -n "$ip" | xsel --clipboard --input 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  elif command -v wl-copy &> /dev/null; then
    if echo -n "$ip" | wl-copy 2>/dev/null; then
      echo "âœ… Copied to clipboard"
    fi
  fi
}

# tmux: Create or attach to session
tm() {
  if [ -z "$1" ]; then
    tmux attach || tmux new
  else
    tmux attach -t "$1" || tmux new -s "$1"
  fi
}

# Update Zen terminal environment from repository
# Usage: zupdate [tags]
# Examples:
#   zupdate           # Update everything
#   zupdate shell     # Update only shell config
#   zupdate "shell,cli-tools"  # Update multiple components
zupdate() {
  local setup_dir=""
  local tags="${1:-}"
  
  echo "ğŸ”„ Updating Zen..."
  echo ""
  
  # Try to find Zen directory
  if [ -n "$ZEN_SETUP_DIR" ] && [ -d "$ZEN_SETUP_DIR" ]; then
    setup_dir="$ZEN_SETUP_DIR"
  elif [ -d "$HOME/.local/share/zen-setup" ]; then
    setup_dir="$HOME/.local/share/zen-setup"
  else
    echo "âŒ Zen directory not found!"
    echo ""
    echo "ğŸ’¡ Checked:"
    echo "   - \$ZEN_SETUP_DIR (not set or doesn't exist)"
    echo "   - ~/.local/share/zen-setup (not found)"
    echo ""
    echo "ğŸ”§ To set your Zen directory location, use zsetdir:"
    echo ""
    echo "   # If you have it installed elsewhere:"
    echo "   zsetdir /path/to/your/zen"
    echo ""
    echo "   # Example:"
    echo "   zsetdir ~/projects/zen"
    echo ""
    echo "ğŸ“¥ Or install fresh:"
    echo "   curl -fsSL https://raw.githubusercontent.com/Ankur-singh/zen-setup/main/install.sh | bash"
    return 1
  fi
  
  echo "ğŸ“‚ Using setup directory: $setup_dir"
  echo ""
  
  cd "$setup_dir" || return 1
  
  # Pull latest changes
  echo "ğŸ“¥ Pulling latest changes from git..."
  local git_output
  git_output=$(git pull 2>&1)
  local git_exit=$?
  
  if [ $git_exit -ne 0 ]; then
    echo "$git_output"
    echo "âŒ Failed to pull changes"
    return 1
  fi
  
  echo "$git_output"
  
  # Check if already up to date
  if echo "$git_output" | grep -q "Already up to date"; then
    echo ""
    echo "âœ… Already up to date! No updates to install."
    echo "ğŸ’¡ To force reinstall anyway, run:"
    echo "   cd $setup_dir && ./bootstrap.sh"
    return 0
  fi
  
  echo ""
  echo "ğŸš€ Running Ansible playbook..."
  
  # Build ansible command
  local cmd="ansible-playbook playbook.yml"
  
  # Add tags if provided
  if [ -n "$tags" ]; then
    cmd="$cmd --tags $tags"
    echo "ğŸ“¦ Updating: $tags"
  else
    echo "ğŸ“¦ Updating: all components"
  fi
  
  # Add --ask-become-pass for Linux
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    cmd="$cmd --ask-become-pass"
  fi
  
  echo ""
  eval "$cmd"
  
  local exit_code=$?
  
  echo ""
  if [ $exit_code -eq 0 ]; then
    echo "âœ… Zen updated successfully!"
    echo ""
    echo "ğŸ”„ Reload your shell to apply changes:"
    if [[ "$OSTYPE" == "darwin"* ]]; then
      echo "   source ~/.zshrc"
    else
      echo "   source ~/.bashrc"
    fi
  else
    echo "âŒ Update failed with exit code: $exit_code"
    return $exit_code
  fi
}

  # Clean up backup files created by Zen
# Usage: zcleanup [--force]
# Examples:
#   zcleanup         # Interactive - shows backups and asks for confirmation
#   zcleanup --force # Delete all backups without confirmation
zcleanup() {
  local force=false
  if [ "$1" = "--force" ] || [ "$1" = "-f" ]; then
    force=true
  fi
  
  echo "ğŸ” Finding backup files created by Zen..."
  echo ""
  
  # Find all backup files
  local backups=()
  
  # Shell config backups
  if ls ~/.bashrc.backup.* 2>/dev/null | head -1 > /dev/null; then
    backups+=( ~/.bashrc.backup.* )
  fi
  if ls ~/.zshrc.backup.* 2>/dev/null | head -1 > /dev/null; then
    backups+=( ~/.zshrc.backup.* )
  fi
  
  # Tmux config backups
  if ls ~/.tmux.conf.backup.* 2>/dev/null | head -1 > /dev/null; then
    backups+=( ~/.tmux.conf.backup.* )
  fi
  
  # Neovim config backups
  if ls -d ~/.config/nvim.backup.* 2>/dev/null | head -1 > /dev/null; then
    backups+=( ~/.config/nvim.backup.* )
  fi
  if ls -d ~/.local/share/nvim.backup.* 2>/dev/null | head -1 > /dev/null; then
    backups+=( ~/.local/share/nvim.backup.* )
  fi
  
  # Check if any backups found
  if [ ${#backups[@]} -eq 0 ]; then
    echo "âœ… No backup files found!"
    return 0
  fi
  
  # Display found backups
  echo "ğŸ“¦ Found ${#backups[@]} backup(s):"
  echo ""
  for backup in "${backups[@]}"; do
    if [ -d "$backup" ]; then
      local size=$(du -sh "$backup" 2>/dev/null | cut -f1)
      echo "  ğŸ“ $backup ($size)"
    else
      local size=$(du -h "$backup" 2>/dev/null | cut -f1)
      echo "  ğŸ“„ $backup ($size)"
    fi
  done
  
  echo ""
  
  # Ask for confirmation unless --force
  if [ "$force" = false ]; then
    read -p "ğŸ—‘ï¸  Delete all these backups? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "âŒ Cancelled. No files deleted."
      return 0
    fi
  fi
  
  # Delete backups
  echo ""
  echo "ğŸ—‘ï¸  Deleting backups..."
  for backup in "${backups[@]}"; do
    if [ -e "$backup" ]; then
      rm -rf "$backup"
      echo "  âœ“ Deleted: $backup"
    fi
  done
  
  echo ""
  echo "âœ… All backups cleaned up!"
}

# Set Zen directory location
# Usage: zsetdir [directory]
# Examples:
#   zsetdir ~/projects/zen
#   zsetdir  # Show current location
zsetdir() {
  local rc_file
  if [[ "$OSTYPE" == "darwin"* ]]; then
    rc_file="$HOME/.zshrc.local"
  else
    rc_file="$HOME/.bashrc.local"
  fi
  
  if [ -z "$1" ]; then
    # Show current location
    if [ -n "$ZEN_SETUP_DIR" ]; then
      echo "ğŸ“‚ Current Zen directory: $ZEN_SETUP_DIR"
    else
      echo "ğŸ“‚ No custom Zen directory set (using default: ~/.local/share/zen-setup)"
    fi
    echo ""
    echo "ğŸ’¡ To set a custom location:"
    echo "   zsetdir /path/to/your/zen"
    return 0
  fi
  
  local new_dir="$1"
  
  # Expand ~ to full path
  new_dir="${new_dir/#\~/$HOME}"
  
  # Check if directory exists
  if [ ! -d "$new_dir" ]; then
    echo "âŒ Directory not found: $new_dir"
    return 1
  fi
  
  # Check if it's actually a Zen repository
  if [ ! -f "$new_dir/playbook.yml" ]; then
    echo "âš ï¸  Warning: $new_dir doesn't look like a Zen repository"
    echo "   (playbook.yml not found)"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      return 1
    fi
  fi
  
  # Add to local RC file
  echo "" >> "$rc_file"
  echo "# Zen directory (set by zsetdir)" >> "$rc_file"
  echo "export ZEN_SETUP_DIR=\"$new_dir\"" >> "$rc_file"
  
  # Set for current session
  export ZEN_SETUP_DIR="$new_dir"
  
  echo "âœ… Zen directory set to: $new_dir"
  echo "ğŸ“ Saved to: $rc_file"
  echo ""
  echo "ğŸ”„ Reload your shell or run: source $rc_file"
}


---
- name: Install Homebrew (if not already installed)
  shell: |
    if ! command -v brew &> /dev/null; then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
  args:
    executable: /bin/bash
  changed_when: false

- name: Install Homebrew packages
  homebrew:
    name: "{{ homebrew_packages }}"
    state: present
    update_homebrew: yes
  when: homebrew_packages is defined

- name: Install Homebrew Cask packages (fonts)
  homebrew_cask:
    name: "{{ homebrew_cask_packages }}"
    state: present
  when: homebrew_cask_packages is defined
  ignore_errors: yes

- name: Initialize fzf key bindings and fuzzy completion
  shell: |
    $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc --no-bash
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.fzf.bash"

- name: Install Lumen (AI-powered diff tool)
  homebrew:
    name: jnsahaj/lumen/lumen
    state: present

- name: Check if Docker is installed (for lazydocker)
  command: which docker
  register: docker_check
  failed_when: false
  changed_when: false

- name: Install lazydocker (only if Docker is installed)
  homebrew:
    name: lazydocker
    state: present
  when:
    - install_lazydocker | default(true)
    - docker_check.rc == 0

- name: Configure lazygit to use delta
  block:
    - name: Check if delta is installed
      command: which delta
      register: delta_installed
      failed_when: false
      changed_when: false

    - name: Ensure lazygit config directory exists (macOS)
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/lazygit"
        state: directory
        mode: '0755'

    - name: Copy lazygit config with delta integration
      copy:
        src: lazygit-config.yml
        dest: "{{ ansible_env.HOME }}/Library/Application Support/lazygit/config.yml"
        mode: '0644'
      when: delta_installed.rc == 0

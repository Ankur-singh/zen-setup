---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install APT packages
  apt:
    name: "{{ apt_packages }}"
    state: present
  become: yes
  when: apt_packages is defined

- name: Install eza (modern ls replacement)
  block:
    - name: Add eza GPG key
      shell: |
        sudo mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
      args:
        executable: /bin/bash
        creates: /etc/apt/sources.list.d/gierens.list

    - name: Install eza
      apt:
        name: eza
        state: present
        update_cache: yes
      become: yes

- name: Install bat (better cat)
  apt:
    name: bat
    state: present
  become: yes

- name: Create bat symlink (batcat -> bat)
  file:
    src: /usr/bin/batcat
    dest: "{{ local_bin_dir }}/bat"
    state: link
  when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

- name: Install fzf (fuzzy finder)
  block:
    - name: Clone fzf repository
      git:
        repo: https://github.com/junegunn/fzf.git
        dest: "{{ ansible_env.HOME }}/.fzf"
        depth: 1
        version: master
      
    - name: Install fzf
      shell: "{{ ansible_env.HOME }}/.fzf/install --key-bindings --completion --no-update-rc --no-bash"
      args:
        executable: /bin/bash
        creates: "{{ ansible_env.HOME }}/.fzf.bash"

- name: Install zoxide (smart cd)
  shell: |
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
  args:
    executable: /bin/bash
    creates: "{{ local_bin_dir }}/zoxide"

- name: Install neovim (latest stable)
  block:
    - name: Add Neovim PPA
      shell: |
        sudo add-apt-repository -y ppa:neovim-ppa/unstable
        sudo apt update
      args:
        executable: /bin/bash
      become: yes
      changed_when: false

    - name: Install Neovim from PPA
      apt:
        name: neovim
        state: present
        update_cache: yes
      become: yes

- name: Install lazygit
  block:
    - name: Try to get latest lazygit version from GitHub
      uri:
        url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
        return_content: yes
        timeout: 10
      register: lazygit_latest_check
      failed_when: false
      changed_when: false

    - name: Set lazygit version (latest or fallback)
      set_fact:
        lazygit_version: "{{ lazygit_latest_check.json.tag_name | regex_replace('^v', '') if lazygit_latest_check.status == 200 else tool_versions.lazygit }}"

    - name: Display lazygit version being installed
      debug:
        msg: "Installing lazygit version {{ lazygit_version }} {{ '(latest)' if lazygit_latest_check.status == 200 else '(fallback - GitHub API unavailable)' }}"

    - name: Download and install lazygit
      shell: |
        curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v{{ lazygit_version }}/lazygit_{{ lazygit_version }}_Linux_x86_64.tar.gz"
        tar xf lazygit.tar.gz lazygit
        install -m 755 lazygit {{ local_bin_dir }}/lazygit
        rm -f lazygit lazygit.tar.gz
      args:
        executable: /bin/bash
        creates: "{{ local_bin_dir }}/lazygit"
  when: install_lazygit | default(true)

- name: Check if Docker is installed
  command: which docker
  register: docker_check
  failed_when: false
  changed_when: false

- name: Install lazydocker (only if Docker is installed)
  shell: |
    curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
  args:
    executable: /bin/bash
    creates: "{{ local_bin_dir }}/lazydocker"
  when:
    - install_lazydocker | default(true)
    - docker_check.rc == 0

- name: Install btop
  block:
    - name: Try to get latest btop version from GitHub
      uri:
        url: https://api.github.com/repos/aristocratos/btop/releases/latest
        return_content: yes
        timeout: 10
      register: btop_latest_check
      failed_when: false
      changed_when: false

    - name: Set btop version (latest or fallback)
      set_fact:
        btop_version: "{{ btop_latest_check.json.tag_name | regex_replace('^v', '') if btop_latest_check.status == 200 else tool_versions.btop }}"

    - name: Display btop version being installed
      debug:
        msg: "Installing btop version {{ btop_version }} {{ '(latest)' if btop_latest_check.status == 200 else '(fallback - GitHub API unavailable)' }}"

    - name: Download and install btop
      shell: |
        curl -Lo btop.tbz "https://github.com/aristocratos/btop/releases/download/v{{ btop_version }}/btop-x86_64-linux-musl.tbz"
        tar xjf btop.tbz
        cd btop && make install PREFIX={{ ansible_env.HOME }}/.local
        cd .. && rm -rf btop btop.tbz
      args:
        executable: /bin/bash
        creates: "{{ local_bin_dir }}/btop"
      become: yes
  when: install_btop | default(true)

- name: Install fastfetch
  block:
    - name: Try to get latest fastfetch version from GitHub
      uri:
        url: https://api.github.com/repos/fastfetch-cli/fastfetch/releases/latest
        return_content: yes
        timeout: 10
      register: fastfetch_latest_check
      failed_when: false
      changed_when: false

    - name: Set fastfetch version (latest or fallback)
      set_fact:
        fastfetch_version: "{{ fastfetch_latest_check.json.tag_name if fastfetch_latest_check.status == 200 else tool_versions.fastfetch }}"

    - name: Display fastfetch version being installed
      debug:
        msg: "Installing fastfetch version {{ fastfetch_version }} {{ '(latest)' if fastfetch_latest_check.status == 200 else '(fallback - GitHub API unavailable)' }}"

    - name: Download and install fastfetch
      shell: |
        wget -qO fastfetch.deb "https://github.com/fastfetch-cli/fastfetch/releases/download/{{ fastfetch_version }}/fastfetch-linux-amd64.deb"
        dpkg -i fastfetch.deb || apt-get install -f -y
        rm -f fastfetch.deb
      args:
        executable: /bin/bash
        creates: /usr/bin/fastfetch
      become: yes
  when: install_fastfetch | default(true)

- name: Install git-delta (beautiful git diffs)
  block:
    - name: Try to get latest delta version from GitHub
      uri:
        url: https://api.github.com/repos/dandavison/delta/releases/latest
        return_content: yes
        timeout: 10
      register: delta_latest_check
      failed_when: false
      changed_when: false

    - name: Set delta version (latest or fallback)
      set_fact:
        delta_version: "{{ delta_latest_check.json.tag_name if delta_latest_check.status == 200 else tool_versions.delta }}"

    - name: Display delta version being installed
      debug:
        msg: "Installing git-delta version {{ delta_version }} {{ '(latest)' if delta_latest_check.status == 200 else '(fallback - GitHub API unavailable)' }}"

    - name: Download and install git-delta
      shell: |
        wget -qO delta.deb "https://github.com/dandavison/delta/releases/download/{{ delta_version }}/git-delta_{{ delta_version }}_amd64.deb"
        dpkg -i delta.deb || apt-get install -f -y
        rm -f delta.deb
      args:
        executable: /bin/bash
        creates: /usr/bin/delta
      become: yes

- name: Configure lazygit to use delta (Linux)
  block:
    - name: Check if delta is installed
      command: which delta
      register: delta_installed
      failed_when: false
      changed_when: false

    - name: Ensure lazygit config directory exists
      file:
        path: "{{ config_dir }}/lazygit"
        state: directory
        mode: '0755'

    - name: Copy lazygit config with delta integration
      copy:
        src: lazygit-config.yml
        dest: "{{ config_dir }}/lazygit/config.yml"
        mode: '0644'
      when: delta_installed.rc == 0
  when: install_lazygit | default(true)

- name: Install gum (TUI for interactive mode)
  block:
    - name: Try to get latest gum version from GitHub
      uri:
        url: https://api.github.com/repos/charmbracelet/gum/releases/latest
        return_content: yes
        timeout: 10
      register: gum_latest_check
      failed_when: false
      changed_when: false

    - name: Set gum version (latest or fallback)
      set_fact:
        gum_version: "{{ gum_latest_check.json.tag_name | regex_replace('^v', '') if gum_latest_check.status == 200 else tool_versions.gum }}"

    - name: Display gum version being installed
      debug:
        msg: "Installing gum version {{ gum_version }} {{ '(latest)' if gum_latest_check.status == 200 else '(fallback - GitHub API unavailable)' }}"

    - name: Download and install gum
      shell: |
        wget -qO gum.deb "https://github.com/charmbracelet/gum/releases/download/v{{ gum_version }}/gum_{{ gum_version }}_amd64.deb"
        dpkg -i gum.deb || apt-get install -f -y
        rm -f gum.deb
      args:
        executable: /bin/bash
        creates: /usr/bin/gum
      become: yes


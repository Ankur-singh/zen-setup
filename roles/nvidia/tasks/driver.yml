---
# NVIDIA Driver installation
# Auto-detects GPU and installs appropriate driver

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Detect NVIDIA GPU
  shell: lspci | grep -i nvidia
  register: nvidia_gpu_check
  failed_when: false
  changed_when: false

- name: Display detected GPU
  debug:
    msg: "{{ nvidia_gpu_check.stdout_lines }}"
  when: nvidia_gpu_check.rc == 0

- name: Skip NVIDIA installation if no GPU detected
  debug:
    msg: "No NVIDIA GPU detected - skipping NVIDIA driver installation"
  when: nvidia_gpu_check.rc != 0

- name: Check if NVIDIA driver is already installed
  shell: nvidia-smi
  register: nvidia_smi_check
  failed_when: false
  changed_when: false

- name: Display current NVIDIA driver info
  debug:
    msg: "{{ nvidia_smi_check.stdout_lines }}"
  when: nvidia_smi_check.rc == 0

- name: Install NVIDIA driver using ubuntu-drivers (recommended)
  block:
    - name: Install ubuntu-drivers-common
      apt:
        name: ubuntu-drivers-common
        state: present
      become: yes

    - name: Auto-install recommended NVIDIA drivers
      command: ubuntu-drivers autoinstall
      become: yes
      when: nvidia_smi_check.rc != 0
      register: nvidia_driver_installed

  when: 
    - nvidia_gpu_check.rc == 0
    - nvidia_install_method | default('auto') == 'auto'

- name: Install specific NVIDIA driver version
  block:
    - name: Add graphics-drivers PPA
      apt_repository:
        repo: ppa:graphics-drivers/ppa
        state: present
        update_cache: yes
      become: yes

    - name: Install NVIDIA driver
      apt:
        name: "nvidia-driver-{{ nvidia_driver_version | default('580') }}"
        state: present
      become: yes
      when: nvidia_smi_check.rc != 0
      register: nvidia_driver_installed

  when: 
    - nvidia_gpu_check.rc == 0
    - nvidia_install_method | default('auto') == 'manual'

- name: Install NVIDIA utilities
  apt:
    name:
      - nvidia-settings
      - nvidia-prime
    state: present
  become: yes
  when: nvidia_gpu_check.rc == 0

- name: Check if reboot is required
  stat:
    path: /var/run/reboot-required
  register: reboot_required
  when: nvidia_gpu_check.rc == 0

- name: Verify NVIDIA driver installation
  shell: nvidia-smi
  register: nvidia_verify
  failed_when: false
  changed_when: false
  when: nvidia_gpu_check.rc == 0

- name: Check if Docker is installed
  command: docker --version
  register: docker_check
  failed_when: false
  changed_when: false
  when: nvidia_gpu_check.rc == 0

- name: Set Docker installation status
  set_fact:
    docker_installed: "{{ docker_check.rc == 0 }}"
  when: nvidia_gpu_check.rc == 0

- name: Display NVIDIA driver installation status
  debug:
    msg: |
      {% if nvidia_verify.rc == 0 %}
      ✅ NVIDIA driver is successfully installed and active!
      
      Driver Info:
      {{ nvidia_verify.stdout }}
      
      {% if docker_installed %}
      ✅ Docker detected - proceeding with Container Toolkit installation...
      {% else %}
      ℹ️  Docker not detected - skipping Container Toolkit installation.
      Install Docker first if you need GPU support in containers.
      {% endif %}
      {% else %}
      ⚠️  NVIDIA driver has been installed but requires a system REBOOT to activate.
      
      Next steps:
        1. Reboot your system: sudo reboot
        2. After reboot, verify with: nvidia-smi
        {% if docker_installed %}
        3. Re-run this playbook to install Container Toolkit
        {% endif %}
      {% endif %}
  when: nvidia_gpu_check.rc == 0


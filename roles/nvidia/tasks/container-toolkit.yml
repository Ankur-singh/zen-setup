---
# NVIDIA Container Toolkit installation for Docker GPU support
# Requires Docker and NVIDIA drivers to be installed first

- name: Check if NVIDIA driver is active
  command: nvidia-smi
  register: nvidia_active_check
  failed_when: false
  changed_when: false

- name: Warn if NVIDIA driver not active
  debug:
    msg: |
      ⚠️  NVIDIA driver not active (nvidia-smi failed).
      You need to reboot your system before installing Container Toolkit.
      Skipping Container Toolkit installation.
  when: nvidia_active_check.rc != 0

- name: Install NVIDIA Container Toolkit
  block:
    - name: Install required packages
      apt:
        name:
          - curl
          - gnupg
        state: present
      become: yes

    - name: Create directory for NVIDIA GPG key
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: Add NVIDIA Container Toolkit GPG key
      shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /etc/apt/keyrings/nvidia-container-toolkit.gpg
        chmod a+r /etc/apt/keyrings/nvidia-container-toolkit.gpg
      args:
        creates: /etc/apt/keyrings/nvidia-container-toolkit.gpg
      become: yes

    - name: Add NVIDIA Container Toolkit repository
      shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/etc/apt/keyrings/nvidia-container-toolkit.gpg] https://#g' | \
          tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      become: yes

    - name: Update apt cache after adding repository
      apt:
        update_cache: yes
      become: yes

    - name: Install NVIDIA Container Toolkit
      apt:
        name: nvidia-container-toolkit
        state: present
      become: yes

    - name: Configure Docker to use NVIDIA runtime
      command: nvidia-ctk runtime configure --runtime=docker
      become: yes
      notify: restart docker

    - name: Verify NVIDIA Container Toolkit installation
      command: nvidia-ctk --version
      register: nvidia_ctk_version
      changed_when: false

    - name: Display NVIDIA Container Toolkit status
      debug:
        msg: |
          ✅ NVIDIA Container Toolkit successfully installed!
          
          Version: {{ nvidia_ctk_version.stdout }}
          
          Docker is configured to use NVIDIA runtime.
          
          Test GPU access in Docker:
            docker run --rm --gpus all nvidia/cuda:12.3.0-base-ubuntu22.04 nvidia-smi
          
          Use in Docker Compose:
            services:
              myservice:
                runtime: nvidia
                environment:
                  - NVIDIA_VISIBLE_DEVICES=all
          
          Or with deploy syntax:
            services:
              myservice:
                deploy:
                  resources:
                    reservations:
                      devices:
                        - driver: nvidia
                          count: all
                          capabilities: [gpu]

  when: nvidia_active_check.rc == 0


#!/bin/bash
# bin/zupdate - Update Zen setup and reinstall components

set -e

ZEN_DIR="${ZEN_SETUP_DIR:-$HOME/.local/share/zen-setup}"
COMPONENTS="${1:-all}"
PROFILE_FILE="$HOME/.local/share/zen-setup/.profile"

# Read stored profile preference (defaults to core if not found)
if [[ -f "$PROFILE_FILE" ]]; then
    STORED_PROFILE=$(cat "$PROFILE_FILE")
    echo "üìã Using saved profile: $STORED_PROFILE"
else
    STORED_PROFILE="core"
    echo "üìã No saved profile found, using default: core"
fi

# Change to Zen directory
if [[ ! -d "$ZEN_DIR" ]]; then
    echo "‚ùå Zen setup directory not found: $ZEN_DIR"
    echo "Set ZEN_SETUP_DIR environment variable to the correct path"
    exit 1
fi

cd "$ZEN_DIR" || exit 1

# Check for updates
echo "Checking for updates..."
git fetch origin

if [[ $(git rev-parse HEAD) == $(git rev-parse origin/main) ]]; then
    echo "‚úÖ Already up to date"
    exit 0
fi

# Show what changed
echo ""
echo "Updates available:"
git log --oneline --graph HEAD..origin/main | head -10
echo ""

# Ask for confirmation
read -p "Update Zen setup? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

# Pull updates
echo "Pulling updates..."
git pull origin main

# Reinstall
echo ""
echo "Reinstalling components with profile: $STORED_PROFILE"

# Build setup command with profile
if [[ "$COMPONENTS" == "all" ]]; then
    # Use stored profile for full reinstall
    if [[ "$STORED_PROFILE" == "enhanced" ]]; then
        exec "$ZEN_DIR/setup.sh" --enhanced
    else
        exec "$ZEN_DIR/setup.sh" --core
    fi
else
    # For specific components, still use stored profile
    if [[ "$STORED_PROFILE" == "enhanced" ]]; then
        exec "$ZEN_DIR/setup.sh" --enhanced --components "$COMPONENTS"
    else
        exec "$ZEN_DIR/setup.sh" --core --components "$COMPONENTS"
    fi
fi

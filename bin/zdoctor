#!/bin/bash
# zdoctor - Health check for Zen terminal environment
#
# Usage: zdoctor [--fix]
#
# Checks that all Zen components are properly installed and configured.
# Use --fix to attempt automatic fixes for common issues.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Status indicators
ok() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
fail() { echo -e "${RED}✗${NC} $1"; }
info() { echo -e "${BLUE}→${NC} $1"; }

# Parse arguments
FIX_MODE=false
for arg in "$@"; do
  case $arg in
    --fix) FIX_MODE=true ;;
    -h|--help)
      echo "zdoctor - Health check for Zen terminal environment"
      echo ""
      echo "Usage: zdoctor [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --fix    Attempt to fix common issues"
      echo "  -h       Show this help"
      exit 0
      ;;
  esac
done

# Detect OS
if [[ "$OSTYPE" == "darwin"* ]]; then
  OS="macOS"
  SHELL_NAME="zsh"
  RC_FILE="$HOME/.zshrc"
else
  OS="Linux"
  SHELL_NAME="bash"
  RC_FILE="$HOME/.bashrc"
fi

echo -e "${CYAN}"
echo "╔═══════════════════════════════════════╗"
echo "║      Zen Health Check                 ║"
echo "╚═══════════════════════════════════════╝"
echo -e "${NC}"
echo -e "Platform: ${BOLD}$OS${NC} (${SHELL_NAME})"
echo ""

# Track issues
ISSUES=0
WARNINGS=0

# Check function
check() {
  local name="$1"
  local cmd="$2"
  local required="${3:-true}"

  if command -v "$cmd" &> /dev/null; then
    local version=$("$cmd" --version 2>/dev/null | head -n1 || echo "installed")
    ok "$name: ${DIM}$version${NC}"
    return 0
  else
    if [[ "$required" == "true" ]]; then
      fail "$name: not found"
      ((ISSUES++))
    else
      warn "$name: not installed (optional)"
      ((WARNINGS++))
    fi
    return 1
  fi
}

# ============================================
# Core Tools
# ============================================
echo -e "${BOLD}Core Tools${NC}"
echo "─────────────────────────────────────"

check "Git" "git"
check "Ansible" "ansible"

if [[ "$OS" == "macOS" ]]; then
  check "Homebrew" "brew"
fi

echo ""

# ============================================
# CLI Tools
# ============================================
echo -e "${BOLD}CLI Tools${NC}"
echo "─────────────────────────────────────"

check "eza" "eza"
check "bat" "bat"
check "fzf" "fzf"
check "ripgrep" "rg"
check "fd" "fd"
check "zoxide" "zoxide"
check "git-delta" "delta"
check "jq" "jq"
check "tree" "tree"

echo ""

# ============================================
# Development Tools
# ============================================
echo -e "${BOLD}Development Tools${NC}"
echo "─────────────────────────────────────"

check "Neovim" "nvim" "false"
check "Tmux" "tmux"
check "Python" "python3"
check "UV" "uv"
check "GitHub CLI" "gh" "false"

# Docker (optional)
if command -v docker &> /dev/null; then
  if docker info &> /dev/null; then
    ok "Docker: running"
  else
    warn "Docker: installed but not running"
    ((WARNINGS++))
  fi
else
  info "Docker: not installed (optional)"
fi

# LazyGit/LazyDocker (optional)
check "lazygit" "lazygit" "false"
check "lazydocker" "lazydocker" "false"
check "btop" "btop" "false"

echo ""

# ============================================
# Shell Configuration
# ============================================
echo -e "${BOLD}Shell Configuration${NC}"
echo "─────────────────────────────────────"

# Check RC file
if [[ -f "$RC_FILE" ]]; then
  ok "RC file exists: $RC_FILE"

  # Check for Zen marker
  if grep -q "# Zen" "$RC_FILE" 2>/dev/null || grep -q "zen" "$RC_FILE" 2>/dev/null; then
    ok "Zen configuration detected"
  else
    warn "Zen configuration not found in $RC_FILE"
    ((WARNINGS++))
  fi
else
  fail "RC file not found: $RC_FILE"
  ((ISSUES++))
fi

# Check shell config directory
SHELL_CONFIG_DIR="$HOME/.$SHELL_NAME"
if [[ -d "$SHELL_CONFIG_DIR" ]]; then
  ok "Shell config directory: $SHELL_CONFIG_DIR"

  # Check for aliases and functions
  [[ -f "$SHELL_CONFIG_DIR/aliases" ]] && ok "  aliases file exists" || warn "  aliases file missing"
  [[ -f "$SHELL_CONFIG_DIR/functions" ]] && ok "  functions file exists" || warn "  functions file missing"
else
  fail "Shell config directory not found: $SHELL_CONFIG_DIR"
  ((ISSUES++))
fi

# Check zsh plugins (macOS) or ble.sh (Linux)
if [[ "$OS" == "macOS" ]]; then
  if [[ -f "$(brew --prefix 2>/dev/null)/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    ok "zsh-autosuggestions installed"
  else
    warn "zsh-autosuggestions not found"
    ((WARNINGS++))
  fi

  if [[ -f "$(brew --prefix 2>/dev/null)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    ok "zsh-syntax-highlighting installed"
  else
    warn "zsh-syntax-highlighting not found"
    ((WARNINGS++))
  fi
else
  if [[ -f "$HOME/.local/share/blesh/ble.sh" ]]; then
    ok "ble.sh installed"
  else
    warn "ble.sh not found (bash autosuggestions)"
    ((WARNINGS++))
  fi
fi

echo ""

# ============================================
# Tmux Configuration
# ============================================
echo -e "${BOLD}Tmux Configuration${NC}"
echo "─────────────────────────────────────"

if [[ -f "$HOME/.tmux.conf" ]]; then
  ok "tmux.conf exists"
else
  fail "tmux.conf not found"
  ((ISSUES++))
fi

if [[ -d "$HOME/.tmux/plugins/tpm" ]]; then
  ok "TPM (Tmux Plugin Manager) installed"
else
  warn "TPM not found - tmux plugins may not work"
  ((WARNINGS++))
fi

echo ""

# ============================================
# Neovim Configuration
# ============================================
if command -v nvim &> /dev/null; then
  echo -e "${BOLD}Neovim Configuration${NC}"
  echo "─────────────────────────────────────"

  if [[ -d "$HOME/.config/nvim" ]]; then
    ok "Neovim config directory exists"

    if [[ -f "$HOME/.config/nvim/lazy-lock.json" ]]; then
      ok "LazyVim plugins detected"
    else
      info "No lazy-lock.json (run nvim to install plugins)"
    fi
  else
    warn "Neovim config directory not found"
    ((WARNINGS++))
  fi

  echo ""
fi

# ============================================
# Zen Setup
# ============================================
echo -e "${BOLD}Zen Setup${NC}"
echo "─────────────────────────────────────"

# Find Zen directory
ZEN_DIR="${ZEN_SETUP_DIR:-$HOME/.local/share/zen-setup}"
if [[ -d "$ZEN_DIR" ]]; then
  ok "Zen directory: $ZEN_DIR"

  # Check if it's a git repo and up to date
  if [[ -d "$ZEN_DIR/.git" ]]; then
    cd "$ZEN_DIR"
    git fetch origin --quiet 2>/dev/null || true
    local_commit=$(git rev-parse HEAD 2>/dev/null)
    remote_commit=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master 2>/dev/null)

    if [[ "$local_commit" == "$remote_commit" ]]; then
      ok "Zen is up to date"
    else
      warn "Zen update available (run zupdate)"
      ((WARNINGS++))
    fi
    cd - > /dev/null
  fi
else
  warn "Zen directory not found at $ZEN_DIR"
  ((WARNINGS++))
fi

echo ""

# ============================================
# Summary
# ============================================
echo "─────────────────────────────────────"
if [[ $ISSUES -eq 0 ]] && [[ $WARNINGS -eq 0 ]]; then
  echo -e "${GREEN}${BOLD}All checks passed!${NC}"
elif [[ $ISSUES -eq 0 ]]; then
  echo -e "${YELLOW}${BOLD}$WARNINGS warning(s), no critical issues${NC}"
else
  echo -e "${RED}${BOLD}$ISSUES issue(s), $WARNINGS warning(s)${NC}"
  echo ""
  echo "Run 'zsetup' to reinstall missing components"
fi
echo ""

exit $ISSUES

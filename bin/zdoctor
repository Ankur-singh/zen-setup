#!/bin/bash
# bin/zdoctor - Health check Zen installation

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m'

# Check if command exists
check_command() {
    if command -v "$1" &>/dev/null; then
        echo -e "${GREEN}✓${NC} $1"
        return 0
    else
        echo -e "${RED}✗${NC} $1 (missing)"
        return 1
    fi
}

echo "Zen Setup Health Check"
echo "======================"
echo ""

# Core tools
echo "Core Tools:"
check_command git
check_command curl
check_command wget
echo ""

# CLI tools
echo "CLI Tools:"
check_command eza
check_command bat
check_command fzf
check_command zoxide
check_command ripgrep
check_command fd
check_command jq
check_command lazygit
check_command btop
check_command fastfetch
check_command delta
check_command gum
echo ""

# Development tools
echo "Development Tools:"
check_command gh
check_command docker
check_command tmux
check_command uv
echo ""

# Shell configuration
echo "Shell Configuration:"
if [[ -f "$HOME/.bashrc" ]] || [[ -f "$HOME/.zshrc" ]]; then
    echo -e "${GREEN}✓${NC} Shell RC file"
else
    echo -e "${RED}✗${NC} Shell RC file"
fi

if [[ -f "$HOME/.bash/aliases" ]] || [[ -f "$HOME/.zsh/aliases" ]]; then
    echo -e "${GREEN}✓${NC} Shell aliases"
else
    echo -e "${RED}✗${NC} Shell aliases"
fi

if [[ -f "$HOME/.bash/functions" ]] || [[ -f "$HOME/.zsh/functions" ]]; then
    echo -e "${GREEN}✓${NC} Shell functions"
else
    echo -e "${RED}✗${NC} Shell functions"
fi
echo ""

# Optional: NVIDIA (Linux only)
if [[ "$(uname -s)" != "Darwin" ]]; then
    echo "NVIDIA (Linux only):"
    if command -v nvidia-smi &>/dev/null; then
        if nvidia-smi &>/dev/null; then
            echo -e "${GREEN}✓${NC} NVIDIA drivers (active)"
            nvidia-smi --query-gpu=name,driver_version --format=csv,noheader | \
                sed 's/^/  /'
        else
            echo -e "${RED}✗${NC} NVIDIA drivers (installed but not active - reboot required)"
        fi
    else
        echo -e "${DIM}○${NC} NVIDIA drivers (not installed)"
    fi

    if command -v nvidia-ctk &>/dev/null; then
        echo -e "${GREEN}✓${NC} NVIDIA Container Toolkit"
    else
        echo -e "${DIM}○${NC} NVIDIA Container Toolkit (not installed)"
    fi
    echo ""
fi

# Docker group (Linux only)
if [[ "$(uname -s)" != "Darwin" ]] && command -v docker &>/dev/null; then
    echo "Docker Configuration:"
    if groups | grep -q docker; then
        echo -e "${GREEN}✓${NC} User in docker group"
    else
        echo -e "${RED}✗${NC} User NOT in docker group (log out/in or run: newgrp docker)"
    fi
    echo ""
fi

echo "Legend:"
echo -e "  ${GREEN}✓${NC} Installed and working"
echo -e "  ${RED}✗${NC} Missing or not working"
echo -e "  ${DIM}○${NC} Optional (not installed)"

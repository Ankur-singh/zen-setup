---
- name: Zen - Complete Terminal Environment
  hosts: all
  become: false
  gather_facts: yes

  pre_tasks:
    - name: Detect OS
      debug:
        msg: "Setting up on {{ ansible_distribution }} ({{ ansible_os_family }})"
      tags: always
    
    - name: Load common variables
      include_vars:
        file: vars/common.yml
      tags: always
    
    - name: Load OS-specific variables
      include_vars:
        file: "vars/{{ ansible_os_family | lower }}.yml"
      tags: always

    - name: Backup existing dotfiles
      shell: |
        [ -f ~/.bashrc ] && cp ~/.bashrc ~/.bashrc.backup.$(date +%Y%m%d_%H%M%S) || true
        [ -f ~/.zshrc ] && cp ~/.zshrc ~/.zshrc.backup.$(date +%Y%m%d_%H%M%S) || true
        [ -f ~/.tmux.conf ] && cp ~/.tmux.conf ~/.tmux.conf.backup.$(date +%Y%m%d_%H%M%S) || true
      args:
        executable: /bin/bash
      changed_when: false
      tags: always

  roles:
    - role: shell
      tags: ['shell', 'core']
    
    - role: cli-tools
      tags: ['cli-tools', 'core']
    
    - role: tmux
      tags: ['tmux', 'core']
    
    - role: neovim
      tags: ['neovim', 'editor']
    
    - role: git
      tags: ['git', 'core']
    
    - role: docker
      tags: ['docker']
      when: install_docker | default(true)
    
    - role: nvidia
      tags: ['nvidia', 'gpu']
      when: 
        - install_nvidia | default(false)
        - ansible_os_family == "Debian"
    
    - role: python
      tags: ['python', 'languages']

  post_tasks:
    - name: Summary
      debug:
        msg: |
          ✅ Zen installation complete!
          
          Next steps:
          {% if docker_group_added is defined and docker_group_added.changed %}
          1. Log out and back in (or run: newgrp docker) to use Docker without sudo
          {% endif %}
          {% if nvidia_driver_installed is defined and nvidia_driver_installed.changed %}
          ⚠️  IMPORTANT: NVIDIA drivers installed - REBOOT YOUR SYSTEM before using GPU!
          {% endif %}
          2. Restart your terminal or run: 
             macOS: source ~/.zshrc
             Linux: source ~/.bashrc
          3. Install Python packages: uv pip install <package>
          4. Configure git: git config --global user.name "Your Name"
                           git config --global user.email "your@email.com"
          
          Installed tools:
          - Modern shell with custom prompt, aliases & functions
          - CLI tools: eza, bat, fzf, zoxide, ripgrep, fd, lazygit, btop, etc.
          - Tmux with plugin manager and sensible defaults
          - Neovim with LazyVim configuration
          - UV for Python package management
          - Git with GitHub CLI
          {% if install_docker | default(true) %}
          - Docker with docker-compose
          {% endif %}
          {% if install_nvidia | default(false) and ansible_os_family == "Debian" %}
          - NVIDIA drivers{% if docker_installed is defined and docker_installed %} and Container Toolkit{% endif %} (GPU support)
          {% endif %}
          
          Run 'zhelp' in your terminal to see available commands!

